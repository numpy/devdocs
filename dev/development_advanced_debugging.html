
<!DOCTYPE html>


<html lang="en" data-content_root="../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Advanced debugging tools &#8212; NumPy v2.5.dev0 Manual</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=eafc0fe6" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Vibur" />
    <link rel="stylesheet" type="text/css" href="../_static/jupyterlite_sphinx.css?v=8ee2c72c" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/numpy.css?v=e8edb4a7" />
  
  <!-- So that users can add custom icons -->
  <script src="../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../_static/documentation_options.js?v=ba1e46c4"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=30646c52"></script>
    <script src="../_static/jupyterlite_sphinx.js?v=96e329c5"></script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script data-domain="numpy.org/doc/stable/" defer="defer" src="https://views.scientific-python.org/js/script.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'dev/development_advanced_debugging';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://numpy.org/doc/_static/versions.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'devdocs';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            true;
        </script>
    <link rel="icon" href="../_static/favicon.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Using GitHub Codespaces for NumPy development" href="development_ghcodespaces.html" />
    <link rel="prev" title="Development workflow" href="development_workflow.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="2.5.dev0" />
    <meta name="docbuild:last-update" content="Feb 28, 2026"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
    
    
    
    <img src="../_static/numpylogo.svg" class="logo__image only-light" alt="NumPy v2.5.dev0 Manual - Home"/>
    <img src="../_static/numpylogo_dark.svg" class="logo__image only-dark pst-js-only" alt="NumPy v2.5.dev0 Manual - Home"/>
  
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../user/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference/index.html">
    API reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../building/index.html">
    Building from source
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../release.html">
    Release notes
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://numpy.org/numpy-tutorials/">
    Learn
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://numpy.org/neps">
    NEPs
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
      
        <div class="navbar-item">

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button></div>
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/numpy/numpy" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../user/index.html">
    User Guide
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../reference/index.html">
    API reference
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../building/index.html">
    Building from source
  </a>
</li>


<li class="nav-item current active">
  <a class="nav-link nav-internal" href="index.html">
    Development
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../release.html">
    Release notes
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://numpy.org/numpy-tutorials/">
    Learn
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://numpy.org/neps">
    NEPs
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm pst-navbar-icon search-button search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
</button></div>
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/numpy/numpy" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="development_environment.html">Setting up and using your development environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="spin.html">Spin: NumPy’s developer tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="howto_build_docs.html">Building the NumPy API and reference docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="development_workflow.html">Development workflow</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Advanced debugging tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="development_ghcodespaces.html">Using GitHub Codespaces for NumPy development</a></li>
<li class="toctree-l1"><a class="reference internal" href="reviewer_guidelines.html">Reviewer guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../benchmarking.html">NumPy benchmarks</a></li>
<li class="toctree-l1"><a class="reference external" href="https://numpy.org/neps/nep-0045-c_style_guide.html">NumPy C style guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="depending_on_numpy.html">For downstream package authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="releasing.html">Releasing a version</a></li>
<li class="toctree-l1"><a class="reference internal" href="governance/index.html">NumPy governance</a></li>
<li class="toctree-l1"><a class="reference internal" href="howto-docs.html">How to contribute to the NumPy documentation</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Contributing to NumPy</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Advanced debugging tools</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="advanced-debugging-tools">
<span id="advanced-debugging"></span><h1>Advanced debugging tools<a class="headerlink" href="#advanced-debugging-tools" title="Link to this heading">#</a></h1>
<p>If you reached here, you want to dive into, or use, more advanced tooling.
This is usually not necessary for first-time contributors and most
day-to-day development.
These are used more rarely, for example close to a new NumPy release,
or when a large or particular complex change was made.</p>
<p>Some of these tools are used in NumPy’s continuous integration tests. If you
see a test failure that only happens under a debugging tool, these instructions
should hopefully enable you to reproduce the test failure locally.</p>
<p>Since not all of these tools are used on a regular basis and only available
on some systems, please expect differences, issues, or quirks;
we will be happy to help if you get stuck and appreciate any improvements
or suggestions to these workflows.</p>
<section id="finding-c-errors-with-additional-tooling">
<h2>Finding C errors with additional tooling<a class="headerlink" href="#finding-c-errors-with-additional-tooling" title="Link to this heading">#</a></h2>
<p>Most development will not require more than a typical debugging toolchain
as shown in <a class="reference internal" href="development_environment.html#debugging"><span class="std std-ref">Debugging</span></a>.
But for example memory leaks can be particularly subtle or difficult to
narrow down.</p>
<p>We do not expect any of these tools to be run by most contributors.
However, you can ensure that we can track down such issues more easily:</p>
<ul class="simple">
<li><p>Tests should cover all code paths, including error paths.</p></li>
<li><p>Try to write short and simple tests. If you have a very complicated test
consider creating an additional simpler test as well.
This can be helpful, because often it is only easy to find which test
triggers an issue and not which line of the test.</p></li>
<li><p>Never use <code class="docutils literal notranslate"><span class="pre">np.empty</span></code> if data is read/used.
<a class="reference external" href="https://valgrind.org/">Valgrind</a> will notice this
and report an error. When you do not care about values, you can generate
random values instead.</p></li>
</ul>
<p>This will help us catch any oversights before your change is released
and means you do not have to worry about making reference counting errors,
which can be intimidating.</p>
<section id="python-debug-build">
<h3>Python debug build<a class="headerlink" href="#python-debug-build" title="Link to this heading">#</a></h3>
<p>Debug builds of Python are easily available for example via the system package
manager on Linux systems, but are also available on other platforms, possibly in
a less convenient format. If you cannot easily install a debug build of Python
from a system package manager, you can build one yourself using <a class="reference external" href="https://github.com/pyenv/pyenv">pyenv</a>. For example, to install and globally
activate a debug build of Python 3.13.3, one would do:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pyenv</span> <span class="n">install</span> <span class="o">-</span><span class="n">g</span> <span class="mf">3.13.3</span>
<span class="n">pyenv</span> <span class="k">global</span> <span class="mf">3.13.3</span>
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">pyenv</span> <span class="pre">install</span></code> builds Python from source, so you must ensure that
Python’s dependencies are installed before building, see the pyenv documentation
for platform-specific installation instructions. You can use <code class="docutils literal notranslate"><span class="pre">pip</span></code> to install
Python dependencies you may need for your debugging session. If there is no
debug wheel available on <em class="xref py py-obj">pypi,</em> you will need to build the dependencies from
source and ensure that your dependencies are also compiled as debug builds.</p>
<p>Often debug builds of Python name the Python executable <code class="docutils literal notranslate"><span class="pre">pythond</span></code> instead of
<code class="docutils literal notranslate"><span class="pre">python</span></code>. To check if you have a debug build of Python installed, you can run
e.g. <code class="docutils literal notranslate"><span class="pre">pythond</span> <span class="pre">-m</span> <span class="pre">sysconfig</span></code> to get the build configuration for the Python
executable. A debug build will be built with debug compiler options in
<code class="docutils literal notranslate"><span class="pre">CFLAGS</span></code> (e.g. <code class="docutils literal notranslate"><span class="pre">-g</span> <span class="pre">-Og</span></code>).</p>
<p>Running the Numpy tests or an interactive terminal is usually as easy as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span><span class="mf">.8</span><span class="n">d</span> <span class="n">runtests</span><span class="o">.</span><span class="n">py</span>
<span class="c1"># or</span>
<span class="n">python3</span><span class="mf">.8</span><span class="n">d</span> <span class="n">runtests</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">ipython</span>
</pre></div>
</div>
<p>and were already mentioned in <a class="reference internal" href="development_environment.html#debugging"><span class="std std-ref">Debugging</span></a>.</p>
<p>A Python debug build will help:</p>
<ul>
<li><p>Find bugs which may otherwise cause random behaviour.
One example is when an object is still used after it has been deleted.</p></li>
<li><p>Python debug builds allows to check correct reference counting.
This works using the additional commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sys</span><span class="o">.</span><span class="n">gettotalrefcount</span><span class="p">()</span>
<span class="n">sys</span><span class="o">.</span><span class="n">getallocatedblocks</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p>Python debug builds allow easier debugging with gdb and other C debuggers.</p></li>
</ul>
<section id="use-together-with-pytest">
<h4>Use together with <code class="docutils literal notranslate"><span class="pre">pytest</span></code><a class="headerlink" href="#use-together-with-pytest" title="Link to this heading">#</a></h4>
<p>Running the test suite only with a debug python build will not find many
errors on its own. An additional advantage of a debug build of Python is that
it allows detecting memory leaks.</p>
<p>A tool to make this easier is <a class="reference external" href="https://github.com/abalkin/pytest-leaks">pytest-leaks</a>, which can be installed using <code class="docutils literal notranslate"><span class="pre">pip</span></code>.
Unfortunately, <code class="docutils literal notranslate"><span class="pre">pytest</span></code> itself may leak memory, but good results can usually
(currently) be achieved by removing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">add_np</span><span class="p">(</span><span class="n">doctest_namespace</span><span class="p">):</span>
    <span class="n">doctest_namespace</span><span class="p">[</span><span class="s1">&#39;np&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">(</span><span class="n">autouse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">env_setup</span><span class="p">(</span><span class="n">monkeypatch</span><span class="p">):</span>
    <span class="n">monkeypatch</span><span class="o">.</span><span class="n">setenv</span><span class="p">(</span><span class="s1">&#39;PYTHONHASHSEED&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>from <code class="docutils literal notranslate"><span class="pre">numpy/conftest.py</span></code> (This may change with new <code class="docutils literal notranslate"><span class="pre">pytest-leaks</span></code> versions
or <code class="docutils literal notranslate"><span class="pre">pytest</span></code> updates).</p>
<p>This allows to run the test suite, or part of it, conveniently:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">python3</span><span class="mf">.8</span><span class="n">d</span> <span class="n">runtests</span><span class="o">.</span><span class="n">py</span> <span class="o">-</span><span class="n">t</span> <span class="n">numpy</span><span class="o">/</span><span class="n">_core</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">test_multiarray</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span> <span class="o">-</span><span class="n">R2</span><span class="p">:</span><span class="mi">3</span> <span class="o">-</span><span class="n">s</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">-R2:3</span></code> is the <code class="docutils literal notranslate"><span class="pre">pytest-leaks</span></code> command (see its documentation), the
<code class="docutils literal notranslate"><span class="pre">-s</span></code> causes output to print and may be necessary (in some versions captured
output was detected as a leak).</p>
<p>Note that some tests are known (or even designed) to leak references, we try
to mark them, but expect some false positives.</p>
</section>
</section>
<section id="id1">
<h3><code class="docutils literal notranslate"><span class="pre">valgrind</span></code><a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://valgrind.org/">Valgrind</a> is a powerful tool
to find certain memory access problems and should
be run on complicated C code.
Basic use of <code class="docutils literal notranslate"><span class="pre">valgrind</span></code> usually requires no more than:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PYTHONMALLOC</span><span class="o">=</span><span class="n">malloc</span> <span class="n">valgrind</span> <span class="n">python</span> <span class="n">runtests</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">PYTHONMALLOC=malloc</span></code> is necessary to avoid false positives from python
itself.
Depending on the system and valgrind version, you may see more false positives.
<code class="docutils literal notranslate"><span class="pre">valgrind</span></code> supports “suppressions” to ignore some of these, and Python does
have a suppression file (and even a compile time option) which may help if you
find it necessary.</p>
<p>Valgrind helps:</p>
<ul>
<li><p>Find use of uninitialized variables/memory.</p></li>
<li><p>Detect memory access violations (reading or writing outside of allocated
memory).</p></li>
<li><p>Find <em>many</em> memory leaks. Note that for <em>most</em> leaks the python
debug build approach (and <code class="docutils literal notranslate"><span class="pre">pytest-leaks</span></code>) is much more sensitive.
The reason is that <code class="docutils literal notranslate"><span class="pre">valgrind</span></code> can only detect if memory is definitely
lost. If:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<span class="n">arr</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
</pre></div>
</div>
<p>Has incorrect reference counting for <code class="docutils literal notranslate"><span class="pre">dtype</span></code>, this is a bug, but valgrind
cannot see it because <code class="docutils literal notranslate"><span class="pre">np.dtype(np.int64)</span></code> always returns the same object.
However, not all dtypes are singletons, so this might leak memory for
different input.
In rare cases NumPy uses <code class="docutils literal notranslate"><span class="pre">malloc</span></code> and not the Python memory allocators
which are invisible to the Python debug build.
<code class="docutils literal notranslate"><span class="pre">malloc</span></code> should normally be avoided, but there are some exceptions
(e.g. the <code class="docutils literal notranslate"><span class="pre">PyArray_Dims</span></code> structure is public API and cannot use the
Python allocators.)</p>
</li>
</ul>
<p>Even though using valgrind for memory leak detection is slow and less sensitive
it can be convenient: you can run most programs with valgrind without
modification.</p>
<p>Things to be aware of:</p>
<ul class="simple">
<li><p>Valgrind does not support the numpy <code class="docutils literal notranslate"><span class="pre">longdouble</span></code>, this means that tests
will fail or be flagged errors that are completely fine.</p></li>
<li><p>Expect some errors before and after running your NumPy code.</p></li>
<li><p>Caches can mean that errors (specifically memory leaks) may not be detected
or are only detect at a later, unrelated time.</p></li>
</ul>
<p>A big advantage of valgrind is that it has no requirements aside from valgrind
itself (although you probably want to use debug builds for better tracebacks).</p>
<section id="id3">
<h4>Use together with <code class="docutils literal notranslate"><span class="pre">pytest</span></code><a class="headerlink" href="#id3" title="Link to this heading">#</a></h4>
<p>You can run the test suite with valgrind which may be sufficient
when you are only interested in a few tests:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PYTHONMALLOC</span><span class="o">=</span><span class="n">malloc</span> <span class="n">valgrind</span> <span class="n">python</span> <span class="n">runtests</span><span class="o">.</span><span class="n">py</span> \
 <span class="o">-</span><span class="n">t</span> <span class="n">numpy</span><span class="o">/</span><span class="n">_core</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">test_multiarray</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span> <span class="o">--</span><span class="k">continue</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">collection</span><span class="o">-</span><span class="n">errors</span>
</pre></div>
</div>
<p>Note the <code class="docutils literal notranslate"><span class="pre">--continue-on-collection-errors</span></code>, which is currently necessary due to
missing <code class="docutils literal notranslate"><span class="pre">longdouble</span></code> support causing failures (this will usually not be
necessary if you do not run the full test suite).</p>
<p>If you wish to detect memory leaks you will also require <code class="docutils literal notranslate"><span class="pre">--show-leak-kinds=definite</span></code>
and possibly more valgrind options.  Just as for <code class="docutils literal notranslate"><span class="pre">pytest-leaks</span></code> certain
tests are known to leak cause errors in valgrind and may or may not be marked
as such.</p>
<p>We have developed <a class="reference external" href="https://github.com/seberg/pytest-valgrind">pytest-valgrind</a> which:</p>
<ul class="simple">
<li><p>Reports errors for each test individually</p></li>
<li><p>Narrows down memory leaks to individual tests (by default valgrind
only checks for memory leaks after a program stops, which is very
cumbersome).</p></li>
</ul>
<p>Please refer to its <code class="docutils literal notranslate"><span class="pre">README</span></code> for more information (it includes an example
command for NumPy).</p>
</section>
</section>
<section id="c-debuggers">
<h3>C debuggers<a class="headerlink" href="#c-debuggers" title="Link to this heading">#</a></h3>
<p>Whenever NumPy crashes or when working on changes to NumPy’s low-level C or C++
code, it’s often convenient to run Python under a C debugger to get more
information. A debugger can aid in understanding an interpreter crash (e.g. due
to a segmentation fault) by providing a C call stack at the site of the
crash. The call stack often provides valuable context to understand the nature
of a crash. C debuggers are also very useful during development, allowing
interactive debugging in the C implementation of NumPy.</p>
<p>The NumPy developers often use both <code class="docutils literal notranslate"><span class="pre">gdb</span></code> and <code class="docutils literal notranslate"><span class="pre">lldb</span></code> to debug Numpy. As a
rule of thumb, <code class="docutils literal notranslate"><span class="pre">gdb</span></code> is often easier to use on Linux while <code class="docutils literal notranslate"><span class="pre">lldb</span></code> is easier
to use on a Mac environment. They have disjoint user interfaces, so you will need to
learn how to use whichever one you land on. The <code class="docutils literal notranslate"><span class="pre">gdb</span></code> to <code class="docutils literal notranslate"><span class="pre">lldb</span></code> <a class="reference external" href="https://lldb.llvm.org/use/map.html">command map</a> is a convenient reference for how to
accomplish common recipes in both debuggers.</p>
<section id="building-with-debug-symbols">
<h4>Building With Debug Symbols<a class="headerlink" href="#building-with-debug-symbols" title="Link to this heading">#</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">spin</span></code> <a class="reference external" href="https://github.com/scientific-python/spin">development workflow tool</a>. has built-in support for working
with both <code class="docutils literal notranslate"><span class="pre">gdb</span></code> and <code class="docutils literal notranslate"><span class="pre">lldb</span></code> via the <code class="docutils literal notranslate"><span class="pre">spin</span> <span class="pre">gdb</span></code> and <code class="docutils literal notranslate"><span class="pre">spin</span> <span class="pre">lldb</span></code> commands.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Building with <code class="docutils literal notranslate"><span class="pre">-Dbuildtype=debug</span></code> has a couple of important effects to
be aware of:</p>
<ul class="simple">
<li><p><strong>Assertions are enabled</strong>: This build type does not define the <code class="docutils literal notranslate"><span class="pre">NDEBUG</span></code>
macro, which means that any C-level assertions in the code will be
active. This is very useful for debugging, as it can help pinpoint
where an unexpected condition occurs.</p></li>
<li><p><strong>Compiler flags may need overriding</strong>: Some compiler toolchains,
particularly those from <code class="docutils literal notranslate"><span class="pre">conda-forge</span></code>, may set optimization flags
like <code class="docutils literal notranslate"><span class="pre">-O2</span></code> by default. These can override the <code class="docutils literal notranslate"><span class="pre">debug</span></code> build type.
To ensure a true debug build in such environments, you may need to
manually unset or override this flag.</p></li>
</ul>
<p>For more details on both points, see the <a class="reference external" href="https://mesonbuild.com/meson-python/how-to-guides/debug-builds.html">meson-python guide on
debug builds</a>.</p>
</div>
<p>For both debuggers, it’s advisable to build NumPy in either the <code class="docutils literal notranslate"><span class="pre">debug</span></code> or
<code class="docutils literal notranslate"><span class="pre">debugoptimized</span></code> meson build profile. To use <code class="docutils literal notranslate"><span class="pre">debug</span></code> you can pass the option
via <code class="docutils literal notranslate"><span class="pre">spin</span> <span class="pre">build</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>spin<span class="w"> </span>build<span class="w"> </span>--<span class="w"> </span>-Dbuildtype<span class="o">=</span>debug
</pre></div>
</div>
<p>to use <code class="docutils literal notranslate"><span class="pre">debugoptimized</span></code> you’re pass <code class="docutils literal notranslate"><span class="pre">-Dbuildtype=debugoptimized</span></code> instead.</p>
<p>You can pass additional arguments to <a class="reference external" href="https://mesonbuild.com/Builtin-options.html">meson setup</a> besides <code class="docutils literal notranslate"><span class="pre">buildtype</span></code> using the
same positional argument syntax for <code class="docutils literal notranslate"><span class="pre">spin</span> <span class="pre">build</span></code>.</p>
</section>
<section id="running-a-test-script">
<h4>Running a Test Script<a class="headerlink" href="#running-a-test-script" title="Link to this heading">#</a></h4>
<p>Let’s say you have a test script named <em class="xref py py-obj">test.py</em> that lives in a <code class="docutils literal notranslate"><span class="pre">test</span></code> folder
in the same directory as the NumPy source checkout. You could execute the test
script using the <code class="docutils literal notranslate"><span class="pre">spin</span></code> build of NumPy with the following incantation:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>spin<span class="w"> </span>gdb<span class="w"> </span>../test/test.py
</pre></div>
</div>
<p>This will launch into gdb. If all you care about is a call stack for a crash,
type “r” and hit enter. Your test script will run and if a crash happens, you
type “bt” to get a traceback. For <code class="docutils literal notranslate"><span class="pre">lldb</span></code>, the instructions are similar, just
replace <code class="docutils literal notranslate"><span class="pre">spin</span> <span class="pre">gdb</span></code> with <code class="docutils literal notranslate"><span class="pre">spin</span> <span class="pre">lldb</span></code>.</p>
<p>You can also set breakpoints and use other more advanced techniques. See the
documentation for your debugger for more details.</p>
<p>One common issue with breakpoints in NumPy is that some code paths get hit
repeatedly during the import of the <code class="docutils literal notranslate"><span class="pre">numpy</span></code> module. This can make it tricky or
tedious to find the first “real” call after the NumPy import has completed and
the <code class="docutils literal notranslate"><span class="pre">numpy</span></code> module is fully initialized.</p>
<p>One workaround is to use a script like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">signal</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">PID</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">do_nothing</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">,</span> <span class="n">do_nothing</span><span class="p">)</span>

<span class="n">os</span><span class="o">.</span><span class="n">kill</span><span class="p">(</span><span class="n">PID</span><span class="p">,</span> <span class="n">signal</span><span class="o">.</span><span class="n">SIGUSR1</span><span class="p">)</span>

<span class="c1"># the code to run under a debugger follows</span>
</pre></div>
</div>
<p>This example installs a signal handler for the <code class="docutils literal notranslate"><span class="pre">SIGUSR1</span></code> signal that does
nothing and then calls <code class="docutils literal notranslate"><span class="pre">os.kill</span></code> on the Python process with the <code class="docutils literal notranslate"><span class="pre">SIGUSR1</span></code>
signal. This causes the signal handler to fire and critically also causes both
<code class="docutils literal notranslate"><span class="pre">gdb</span></code> and <code class="docutils literal notranslate"><span class="pre">lldb</span></code> to halt execution inside of the <code class="docutils literal notranslate"><span class="pre">kill</span></code> syscall.</p>
<p>If you run <code class="docutils literal notranslate"><span class="pre">lldb</span></code> you should see output something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Process 67365 stopped
 * thread #1, queue = &#39;com.apple.main-thread&#39;, stop reason = signal SIGUSR1
     frame #0: 0x000000019c4b9da4 libsystem_kernel.dylib`__kill + 8
 libsystem_kernel.dylib`__kill:
 -&gt;  0x19c4b9da4 &lt;+8&gt;:  b.lo   0x19c4b9dc4    ; &lt;+40&gt;
     0x19c4b9da8 &lt;+12&gt;: pacibsp
     0x19c4b9dac &lt;+16&gt;: stp    x29, x30, [sp, #-0x10]!
     0x19c4b9db0 &lt;+20&gt;: mov    x29, sp
 Target 0: (python3.13) stopped.
 (lldb) bt
 * thread #1, queue = &#39;com.apple.main-thread&#39;, stop reason = signal SIGUSR1
   * frame #0: 0x000000019c4b9da4 libsystem_kernel.dylib`__kill + 8
     frame #1: 0x000000010087f5c4 libpython3.13.dylib`os_kill + 104
     frame #2: 0x000000010071374c libpython3.13.dylib`cfunction_vectorcall_FASTCALL + 276
     frame #3: 0x00000001006c1e3c libpython3.13.dylib`PyObject_Vectorcall + 88
     frame #4: 0x00000001007edd1c libpython3.13.dylib`_PyEval_EvalFrameDefault + 23608
     frame #5: 0x00000001007e7e6c libpython3.13.dylib`PyEval_EvalCode + 252
     frame #6: 0x0000000100852944 libpython3.13.dylib`run_eval_code_obj + 180
     frame #7: 0x0000000100852610 libpython3.13.dylib`run_mod + 220
     frame #8: 0x000000010084fa4c libpython3.13.dylib`_PyRun_SimpleFileObject + 868
     frame #9: 0x000000010084f400 libpython3.13.dylib`_PyRun_AnyFileObject + 160
     frame #10: 0x0000000100874ab8 libpython3.13.dylib`pymain_run_file + 336
     frame #11: 0x0000000100874324 libpython3.13.dylib`Py_RunMain + 1516
     frame #12: 0x000000010087459c libpython3.13.dylib`pymain_main + 324
     frame #13: 0x000000010087463c libpython3.13.dylib`Py_BytesMain + 40
     frame #14: 0x000000019c152b98 dyld`start + 6076
(lldb)
</pre></div>
</div>
<p>As you can see, the C stack trace is inside of the <code class="docutils literal notranslate"><span class="pre">kill</span></code> syscall and an
<code class="docutils literal notranslate"><span class="pre">lldb</span></code> prompt is active, allowing interactively setting breakpoints. Since the
<code class="docutils literal notranslate"><span class="pre">os.kill</span></code> call happens after the <code class="docutils literal notranslate"><span class="pre">numpy</span></code> module is already fully
initialized, this means any breakpoints set inside of <code class="docutils literal notranslate"><span class="pre">kill</span></code> will happen
<em>after</em> <code class="docutils literal notranslate"><span class="pre">numpy</span></code> is finished initializing.</p>
</section>
<section id="id4">
<h4>Use together with <code class="docutils literal notranslate"><span class="pre">pytest</span></code><a class="headerlink" href="#id4" title="Link to this heading">#</a></h4>
<p>You can also run <code class="docutils literal notranslate"><span class="pre">pytest</span></code> tests under a debugger. This requires using
the debugger in a slightly more manual fashion, since <code class="docutils literal notranslate"><span class="pre">spin</span></code> does not yet
automate this process. First, run <code class="docutils literal notranslate"><span class="pre">spin</span> <span class="pre">build</span></code> to ensure there is a fully
built copy of NumPy managed by <code class="docutils literal notranslate"><span class="pre">spin</span></code>. Then, to run the tests under <code class="docutils literal notranslate"><span class="pre">lldb</span></code>
you would do something like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>spin<span class="w"> </span>lldb<span class="w"> </span><span class="k">$(</span>which<span class="w"> </span>python<span class="k">)</span><span class="w"> </span><span class="k">$(</span>which<span class="w"> </span>pytest<span class="k">)</span><span class="w"> </span>build-install/usr/lib/python3.13/site-packages/numpy/_core/tests/test_multiarray.py
</pre></div>
</div>
<p>This will execute the tests in <code class="docutils literal notranslate"><span class="pre">test_multiarray.py</span></code> under lldb after typing
‘r’ and hitting enter. Note that this command comes from a session using Python
3.13 on a Mac. If you are using a different Python version or operating system,
the directory layout inside <code class="docutils literal notranslate"><span class="pre">build-install</span></code> may be slightly different.</p>
<p>You can set breakpoints as described above. The issue about breakpoints
commonly being hit during NumPy import also applies - consider refactoring your
test workflow into a test script so you can adopt the workaround using
<code class="docutils literal notranslate"><span class="pre">os.kill</span></code> described above.</p>
<p>Note the use of <code class="docutils literal notranslate"><span class="pre">$(which</span> <span class="pre">python)</span></code> to ensure the debugger receives a path to a
Python executable. If you are using <code class="docutils literal notranslate"><span class="pre">pyenv</span></code>, you may need to replace <code class="docutils literal notranslate"><span class="pre">which</span>
<span class="pre">python</span></code> with <code class="docutils literal notranslate"><span class="pre">pyenv</span> <span class="pre">which</span> <span class="pre">python</span></code>, since <code class="docutils literal notranslate"><span class="pre">pyenv</span></code> relies on shim scripts
that <code class="docutils literal notranslate"><span class="pre">which</span></code> doesn’t know about.</p>
</section>
</section>
<section id="compiler-sanitizers">
<h3>Compiler Sanitizers<a class="headerlink" href="#compiler-sanitizers" title="Link to this heading">#</a></h3>
<p>The <a class="reference external" href="https://hpc-wiki.info/hpc/Compiler_Sanitizers">compiler sanitizer</a> suites
shipped by both GCC and LLVM offer a means to detect many common programming
errors at runtime. The sanitizers work by instrumenting the application code at
build time so additional runtime checks fire. Typically, sanitizers are run
during the course of regular testing and if a sanitizer check fails, this leads
to a test failure or crash, along with a report about the nature of the failure.</p>
<p>While it is possible to use sanitizers with a “regular” build of CPython - it is
best if you can set up a Python environment based on a from-source Python build
with sanitizer instrumentation, and then use the instrumented Python to build
NumPy and run the tests. If the entire Python stack is instrumented using the
same sanitizer runtime, it becomes possible to identify issues that happen
across the Python stack. This enables detecting memory leaks in NumPy due to
misuse of memory allocated in CPython, for example.</p>
<section id="build-python-with-sanitizer-instrumentation">
<h4>Build Python with Sanitizer Instrumentation<a class="headerlink" href="#build-python-with-sanitizer-instrumentation" title="Link to this heading">#</a></h4>
<p>See the <a class="reference external" href="https://devguide.python.org/getting-started/setup-building/">section in the Python developer’s guide</a> on this topic for
more information about building Python from source. To enable address sanitizer,
you will need to pass <code class="docutils literal notranslate"><span class="pre">--with-address-sanitizer</span></code> to the <code class="docutils literal notranslate"><span class="pre">configure</span></code> script
invocation when you build Python.</p>
<p>You can also use <a class="reference external" href="https://github.com/pyenv/pyenv">pyenv</a> to automate the
process of building Python and quickly activate or deactivate a Python
installation using a command-line interface similar to virtual
environments. With <code class="docutils literal notranslate"><span class="pre">pyenv</span></code> you could install an ASAN-instrumented build of
Python 3.13 like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">CONFIGURE_OPTS</span><span class="o">=</span><span class="s2">&quot;--with-address-sanitizer&quot;</span><span class="w"> </span>pyenv<span class="w"> </span>install<span class="w"> </span><span class="m">3</span>.13
</pre></div>
</div>
<p>If you are interested in thread sanitizer, the <code class="docutils literal notranslate"><span class="pre">cpython_sanity</span></code> <a class="reference external" href="https://github.com/nascheme/cpython_sanity">docker images</a> might also be a quicker choice
that bypasses building Python from source, although it may be annoying to do
debugging work inside of a docker image.</p>
</section>
<section id="use-together-with-spin">
<h4>Use together with <code class="docutils literal notranslate"><span class="pre">spin</span></code><a class="headerlink" href="#use-together-with-spin" title="Link to this heading">#</a></h4>
<p>However you build Python, once you have an instrumented Python build, you can
install NumPy’s development and test dependencies and build NumPy with address
sanitizer instrumentation. For example, to build NumPy with the <code class="docutils literal notranslate"><span class="pre">debug</span></code>
profile and address sanitizer, you would pass additional build options to
<code class="docutils literal notranslate"><span class="pre">meson</span></code> like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>spin<span class="w"> </span>build<span class="w"> </span>--<span class="w"> </span>-Dbuildtype<span class="o">=</span>debug<span class="w"> </span>-Db_sanitize<span class="o">=</span>address
</pre></div>
</div>
<p>Once the build is finished, you can use other <code class="docutils literal notranslate"><span class="pre">spin</span></code> command like <code class="docutils literal notranslate"><span class="pre">spin</span>
<span class="pre">test</span></code> and <code class="docutils literal notranslate"><span class="pre">spin</span> <span class="pre">gdb</span></code> as with any other Python build.</p>
</section>
<section id="special-considerations">
<h4>Special considerations<a class="headerlink" href="#special-considerations" title="Link to this heading">#</a></h4>
<p>Some NumPy tests intentionally lead to <code class="docutils literal notranslate"><span class="pre">malloc</span></code> returning <code class="docutils literal notranslate"><span class="pre">NULL</span></code>. In its
default configuration, some of the compiler sanitizers flag this as an
error. You can disable that check by passing <code class="docutils literal notranslate"><span class="pre">allocator_may_return_null=1</span></code> to
the sanitizer as an option. For example, with address sanitizer:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">ASAN_OPTIONS</span><span class="o">=</span><span class="nv">allocator_may_return_null</span><span class="o">=</span><span class="m">1</span><span class="w"> </span>spin<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>You may see memory leaks coming from the Python interpreter, particularly on
MacOS. If the memory leak reports are not useful, you can disable leak detection
by passing <code class="docutils literal notranslate"><span class="pre">detect_leaks=0</span></code> in <code class="docutils literal notranslate"><span class="pre">ASAN_OPTIONS</span></code>. You can pass more than one
option using a colon-delimited list, like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">ASAN_OPTIONS</span><span class="o">=</span><span class="nv">allocator_may_return_null</span><span class="o">=</span><span class="m">1</span>:halt_on_error<span class="o">=</span><span class="m">1</span>:detect_leaks<span class="o">=</span><span class="m">1</span><span class="w"> </span>spin<span class="w"> </span><span class="nb">test</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">halt_on_error</span></code> option can be particularly useful – it hard-crashes the
Python executable whenever it detects an error, along with a report about the
error that includes a stack trace.</p>
<p>You can also take a look at the <code class="docutils literal notranslate"><span class="pre">compiler_sanitizers.yml</span></code> GitHub actions
workflow configuration. It describes several different CI jobs that are run as
part of the NumPy tests using Thread, Address, and Undefined Behavior sanitizer.</p>
</section>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="development_workflow.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Development workflow</p>
      </div>
    </a>
    <a class="right-next"
       href="development_ghcodespaces.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Using GitHub Codespaces for NumPy development</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-c-errors-with-additional-tooling">Finding C errors with additional tooling</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#python-debug-build">Python debug build</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#use-together-with-pytest">Use together with <code class="docutils literal notranslate"><span class="pre">pytest</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1"><code class="docutils literal notranslate"><span class="pre">valgrind</span></code></a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Use together with <code class="docutils literal notranslate"><span class="pre">pytest</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#c-debuggers">C debuggers</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#building-with-debug-symbols">Building With Debug Symbols</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#running-a-test-script">Running a Test Script</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">Use together with <code class="docutils literal notranslate"><span class="pre">pytest</span></code></a></li>
</ul>
</li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#compiler-sanitizers">Compiler Sanitizers</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#build-python-with-sanitizer-instrumentation">Build Python with Sanitizer Instrumentation</a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#use-together-with-spin">Use together with <code class="docutils literal notranslate"><span class="pre">spin</span></code></a></li>
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#special-considerations">Special considerations</a></li>
</ul>
</li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2008-2026, NumPy Developers.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>